name: Deploy Landing Page from DesktopClient

on:
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/deploy-landing-from-desktopclient.yml'
      - 'index.html'
      - 'assets/**'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Download landing page from Vercel
        id: download-vercel
        continue-on-error: true
        run: |
          echo "üì• Downloading landing page from Vercel..."
          curl -L https://nozy-wallet.vercel.app/ -o vercel-landing.html || echo "Failed to download from Vercel"
          
      - name: Checkout DesktopClient repository (fallback)
        id: checkout-desktopclient
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: LEONINE-DAO/NozyWallet-DesktopClient
          path: desktopclient
          token: ${{ secrets.DESKTOPCLIENT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare site
        run: |
          # Create site directory
          mkdir -p _site
          
          # Priority 1: Use local index.html (we host Vercel page directly now)
          if [ -f main-repo/index.html ]; then
            echo "‚úÖ Using local index.html (hosting Vercel page directly)"
            cp main-repo/index.html _site/index.html
          
          # Priority 2: Try DesktopClient repo if local not available and checkout succeeded
          elif [ -d desktopclient ] && [ "${{ steps.checkout-desktopclient.outcome }}" == "success" ]; then
            echo "‚úÖ DesktopClient repo checked out successfully"
            # Look for index.html in common locations
            if [ -f desktopclient/index.html ]; then
              echo "üìÑ Found index.html in root"
              cp desktopclient/index.html _site/
            elif [ -f desktopclient/public/index.html ]; then
              echo "üìÑ Found index.html in public/"
              cp desktopclient/public/index.html _site/
            elif [ -f desktopclient/src/index.html ]; then
              echo "üìÑ Found index.html in src/"
              cp desktopclient/src/index.html _site/
            elif [ -f desktopclient/docs/index.html ]; then
              echo "üìÑ Found index.html in docs/"
              cp desktopclient/docs/index.html _site/
            else
              echo "‚ö†Ô∏è  Landing page not found in DesktopClient repo, using local fallback"
              if [ -f main-repo/index.html ]; then
                cp main-repo/index.html _site/
              else
                # Create a simple redirect page
                cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0; url=https://github.com/LEONINE-DAO/NozyWallet-DesktopClient">
            <title>NozyWallet - Redirecting...</title>
          </head>
          <body>
            <p>Redirecting to <a href="https://github.com/LEONINE-DAO/NozyWallet-DesktopClient">NozyWallet DesktopClient</a>...</p>
          </body>
          </html>
          EOF
              fi
            fi
            
            # Copy any assets (CSS, JS, images) from DesktopClient
            if [ -d desktopclient/public ]; then
              cp -r desktopclient/public/* _site/ 2>/dev/null || true
            fi
            if [ -d desktopclient/assets ]; then
              cp -r desktopclient/assets _site/ 2>/dev/null || true
            fi
            if [ -d desktopclient/static ]; then
              cp -r desktopclient/static _site/ 2>/dev/null || true
            fi
          fi
          
          # Final fallback: Ensure index.html exists
          if [ ! -f _site/index.html ]; then
            echo "‚ö†Ô∏è  No landing page found, creating fallback"
            if [ -f main-repo/index.html ]; then
              echo "üìÑ Using local index.html as final fallback"
              cp main-repo/index.html _site/index.html
            else
              cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>NozyWallet - Privacy by Default</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
          </head>
          <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
            <h1>ü¶ã NozyWallet</h1>
            <p>Privacy by Default</p>
            <p><a href="/downloads/">Download NozyWallet</a></p>
            <p style="color: #666; margin-top: 50px;">
              Note: Landing page from DesktopClient repo not available. 
              <br>Using fallback page. Check repository access or use local landing page.
            </p>
          </body>
          </html>
          EOF
            fi
          fi
          
          # Verify index.html exists
          if [ -f _site/index.html ]; then
            echo "‚úÖ Landing page ready: _site/index.html"
            ls -lh _site/index.html
          else
            echo "‚ùå ERROR: index.html not created!"
            exit 1
          fi
          
          # Copy downloads page from main repo
          mkdir -p _site/downloads
          if [ -d main-repo/downloads ]; then
            cp -r main-repo/downloads/* _site/downloads/ 2>/dev/null || true
          fi
          
          # Copy assets folder (REQUIRED for Vercel landing page to work)
          if [ -d main-repo/assets ]; then
            echo "üì¶ Copying assets folder (REQUIRED)"
            cp -r main-repo/assets _site/ 2>/dev/null || true
            if [ -d _site/assets ]; then
              echo "‚úÖ Assets folder copied successfully"
              ls -la _site/assets/ || true
            else
              echo "‚ùå ERROR: Assets folder not copied!"
              exit 1
            fi
            
            # React bundle expects /logo.png at root, so copy it there too
            if [ -f main-repo/assets/logo.png ]; then
              echo "üì¶ Copying logo.png to root (React bundle expects /logo.png)"
              cp main-repo/assets/logo.png _site/logo.png
              echo "‚úÖ Logo copied to root"
            fi
          else
            echo "‚ùå ERROR: Assets folder not found in main-repo!"
            exit 1
          fi
          
          # List what we're deploying
          echo "üì¶ Deploying:"
          find _site -type f | head -20
          if [ -d _site/assets ]; then
            echo "‚úÖ Assets folder contents:"
            ls -la _site/assets/ || true
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

