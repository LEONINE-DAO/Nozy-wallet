name: Deploy Landing Page from DesktopClient

on:
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/deploy-landing-from-desktopclient.yml'
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Download landing page from Vercel
        id: download-vercel
        continue-on-error: true
        run: |
          echo "ðŸ“¥ Downloading landing page from Vercel..."
          curl -L https://nozy-wallet.vercel.app/ -o vercel-landing.html || echo "Failed to download from Vercel"
          
      - name: Checkout DesktopClient repository (fallback)
        id: checkout-desktopclient
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: LEONINE-DAO/NozyWallet-DesktopClient
          path: desktopclient
          token: ${{ secrets.DESKTOPCLIENT_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare site
        run: |
          # Create site directory
          mkdir -p _site
          
          # Always ensure we have a landing page - start with local as default
          if [ -f main-repo/index.html ]; then
            echo "ðŸ“„ Using local index.html as base"
            cp main-repo/index.html _site/index.html
          fi
          
          # Priority 1: Try to use Vercel landing page if downloaded successfully
          if [ -f vercel-landing.html ] && [ "${{ steps.download-vercel.outcome }}" == "success" ]; then
            echo "âœ… Overriding with landing page from Vercel"
            cp vercel-landing.html _site/index.html
            # Update asset paths to use Vercel CDN (keeps CSS/JS working)
            sed -i 's|href="/|href="https://nozy-wallet.vercel.app/|g' _site/index.html || true
            sed -i 's|src="/|src="https://nozy-wallet.vercel.app/|g' _site/index.html || true
            echo "âœ… Updated asset paths to use Vercel CDN"
          
          # Priority 2: Try DesktopClient repo if it was checked out successfully
          elif [ -d desktopclient ] && [ "${{ steps.checkout-desktopclient.outcome }}" == "success" ]; then
            echo "âœ… DesktopClient repo checked out successfully"
            # Look for index.html in common locations
            if [ -f desktopclient/index.html ]; then
              echo "ðŸ“„ Found index.html in root"
              cp desktopclient/index.html _site/
            elif [ -f desktopclient/public/index.html ]; then
              echo "ðŸ“„ Found index.html in public/"
              cp desktopclient/public/index.html _site/
            elif [ -f desktopclient/src/index.html ]; then
              echo "ðŸ“„ Found index.html in src/"
              cp desktopclient/src/index.html _site/
            elif [ -f desktopclient/docs/index.html ]; then
              echo "ðŸ“„ Found index.html in docs/"
              cp desktopclient/docs/index.html _site/
            else
              echo "âš ï¸  Landing page not found in DesktopClient repo, using local fallback"
              if [ -f main-repo/index.html ]; then
                cp main-repo/index.html _site/
              else
                # Create a simple redirect page
                cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0; url=https://github.com/LEONINE-DAO/NozyWallet-DesktopClient">
            <title>NozyWallet - Redirecting...</title>
          </head>
          <body>
            <p>Redirecting to <a href="https://github.com/LEONINE-DAO/NozyWallet-DesktopClient">NozyWallet DesktopClient</a>...</p>
          </body>
          </html>
          EOF
              fi
            fi
            
            # Copy any assets (CSS, JS, images) from DesktopClient
            if [ -d desktopclient/public ]; then
              cp -r desktopclient/public/* _site/ 2>/dev/null || true
            fi
            if [ -d desktopclient/assets ]; then
              cp -r desktopclient/assets _site/ 2>/dev/null || true
            fi
            if [ -d desktopclient/static ]; then
              cp -r desktopclient/static _site/ 2>/dev/null || true
            fi
          fi
          
          # Final fallback: Ensure index.html exists
          if [ ! -f _site/index.html ]; then
            echo "âš ï¸  No landing page found, creating fallback"
            if [ -f main-repo/index.html ]; then
              echo "ðŸ“„ Using local index.html as final fallback"
              cp main-repo/index.html _site/index.html
            else
              cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>NozyWallet - Privacy by Default</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
          </head>
          <body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;">
            <h1>ðŸ¦‹ NozyWallet</h1>
            <p>Privacy by Default</p>
            <p><a href="/downloads/">Download NozyWallet</a></p>
            <p style="color: #666; margin-top: 50px;">
              Note: Landing page from DesktopClient repo not available. 
              <br>Using fallback page. Check repository access or use local landing page.
            </p>
          </body>
          </html>
          EOF
            fi
          fi
          
          # Verify index.html exists
          if [ -f _site/index.html ]; then
            echo "âœ… Landing page ready: _site/index.html"
            ls -lh _site/index.html
          else
            echo "âŒ ERROR: index.html not created!"
            exit 1
          fi
          
          # Copy downloads page from main repo
          mkdir -p _site/downloads
          if [ -d main-repo/downloads ]; then
            cp -r main-repo/downloads/* _site/downloads/ 2>/dev/null || true
          fi
          
          # Copy assets folder (for Vercel landing page)
          if [ -d main-repo/assets ]; then
            echo "ðŸ“¦ Copying assets folder"
            cp -r main-repo/assets _site/ 2>/dev/null || true
          fi
          
          # List what we're deploying
          echo "ðŸ“¦ Deploying:"
          find _site -type f | head -20
          if [ -d _site/assets ]; then
            echo "âœ… Assets folder contents:"
            ls -la _site/assets/ || true
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

