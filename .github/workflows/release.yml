name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  
  workflow_dispatch:  

permissions:
  contents: write

jobs:
  build-cli:
    name: Build CLI Binaries
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: nozy
            extension: ""
            friendly_name: nozy-linux
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: nozy.exe
            extension: ".exe"
            friendly_name: nozy-windows.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            binary: nozy
            extension: ""
            friendly_name: nozy-macos-intel
          - os: macos-latest
            target: aarch64-apple-darwin
            binary: nozy
            extension: ""
            friendly_name: nozy-macos-arm
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Verify Cargo.lock is up to date
        run: |
          cargo generate-lockfile --check || (echo "‚ùå Cargo.lock is out of date. Run 'cargo update' and commit Cargo.lock" && exit 1)
          echo "‚úÖ Cargo.lock is up to date"

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: cargo audit || (echo "‚ùå Security vulnerabilities found. Fix before release." && exit 1)

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            zeaking
            api-server

      - name: Configure Cargo network retry
        run: |
          mkdir -p $HOME/.cargo
          cat >> $HOME/.cargo/config.toml << EOF
          [net]
          retry = 3
          git-fetch-with-cli = true
          EOF
        shell: bash

      - name: Build CLI binary
        env:
          CARGO_NET_TIMEOUT: 300
        run: |
          cargo build --release --target ${{ matrix.target }} --bin nozy || \
          (echo "Build failed, retrying..." && sleep 5 && \
           cargo build --release --target ${{ matrix.target }} --bin nozy)
        timeout-minutes: 45

      - name: Rename binary to friendly name and generate hash
        shell: bash
        run: |
          cp target/${{ matrix.target }}/release/${{ matrix.binary }} ${{ matrix.friendly_name }}
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            certutil -hashfile ${{ matrix.friendly_name }} SHA256 | findstr /v "SHA256" | findstr /v "certutil" > ${{ matrix.friendly_name }}.sha256
          else
            shasum -a 256 ${{ matrix.friendly_name }} > ${{ matrix.friendly_name }}.sha256
          fi

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        continue-on-error: false
        with:
          name: nozy-cli-${{ matrix.target }}${{ matrix.extension }}
          path: |
            ${{ matrix.friendly_name }}
            ${{ matrix.friendly_name }}.sha256
          retention-days: 90
          if-no-files-found: error

  build-api:
    name: Build API Server Binaries
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: nozywallet-api
            extension: ""
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: nozywallet-api.exe
            extension: ".exe"
          - os: macos-latest
            target: x86_64-apple-darwin
            binary: nozywallet-api
            extension: ""
          - os: macos-latest
            target: aarch64-apple-darwin
            binary: nozywallet-api
            extension: ""
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Verify Cargo.lock is up to date
        run: |
          cargo generate-lockfile --check || (echo "‚ùå Cargo.lock is out of date. Run 'cargo update' and commit Cargo.lock" && exit 1)
          echo "‚úÖ Cargo.lock is up to date"

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: cargo audit || (echo "‚ùå Security vulnerabilities found. Fix before release." && exit 1)

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          workspaces: |
            zeaking
            api-server

      - name: Configure Cargo network retry
        run: |
          mkdir -p $HOME/.cargo
          cat >> $HOME/.cargo/config.toml << EOF
          [net]
          retry = 3
          git-fetch-with-cli = true
          EOF
        shell: bash

      - name: Build API server binary
        env:
          CARGO_NET_TIMEOUT: 300
        run: |
          cargo build --release --target ${{ matrix.target }} --package nozywallet-api || \
          (echo "Build failed, retrying..." && sleep 5 && \
           cargo build --release --target ${{ matrix.target }} --package nozywallet-api)
        timeout-minutes: 45

      - name: Generate SHA256 hash
        id: hash
        shell: bash
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            certutil -hashfile target/${{ matrix.target }}/release/${{ matrix.binary }} SHA256 | findstr /v "SHA256" | findstr /v "certutil" > hash.txt
          else
            shasum -a 256 target/${{ matrix.target }}/release/${{ matrix.binary }} > hash.txt
          fi
          HASH=$(cat hash.txt | awk '{print $1}')
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Generated hash: $HASH"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        continue-on-error: false
        with:
          name: nozywallet-api-${{ matrix.target }}${{ matrix.extension }}
          path: |
            target/${{ matrix.target }}/release/${{ matrix.binary }}
            hash.txt
          retention-days: 90
          if-no-files-found: error

  create-release:
    name: Create Release
    needs: [build-cli, build-api]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: false
        with:
          path: artifacts

      - name: Rename and organize release files
        run: |
          mkdir -p release-files
          # Copy and rename CLI binaries to friendly names
          find artifacts -type f -name "nozy-*" ! -name "*.sha256" ! -name "*.txt" -exec cp {} release-files/ \;
          find artifacts -type f -name "nozy-*.sha256" -exec cp {} release-files/ \;
          # Copy API server binaries (keep original names)
          find artifacts -type f -name "nozywallet-api-*" ! -name "*.sha256" ! -name "*.txt" -exec cp {} release-files/ \;
          find artifacts -type f -name "nozywallet-api-*.sha256" -exec cp {} release-files/ \; || true

      - name: Generate hashes file
        run: |
          echo "# NozyWallet Release Hashes" > release-files/HASHES.txt
          echo "" >> release-files/HASHES.txt
          echo "## SHA256 Hashes" >> release-files/HASHES.txt
          echo "" >> release-files/HASHES.txt
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> release-files/HASHES.txt
          echo "Version: ${GITHUB_REF#refs/tags/}" >> release-files/HASHES.txt
          echo "" >> release-files/HASHES.txt
          echo "## CLI Binaries" >> release-files/HASHES.txt
          echo "" >> release-files/HASHES.txt
          
          # Collect all hash files
          find release-files -name "*.sha256" -exec cat {} \; >> release-files/HASHES.txt || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/**
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üéâ NozyWallet ${GITHUB_REF#refs/tags/} Release
            
            ### üì¶ Downloads
            
            **CLI Binary:**
            - **Windows (x86_64):** `nozy-windows.exe`
            - **Linux (x86_64):** `nozy-linux`
            - **macOS Intel:** `nozy-macos-intel`
            - **macOS Apple Silicon (M1/M2/M3):** `nozy-macos-arm`
            
            **API Server:**
            - Linux (x86_64): `nozywallet-api-x86_64-unknown-linux-gnu`
            - Windows (x86_64): `nozywallet-api-x86_64-pc-windows-msvc.exe`
            - macOS Intel: `nozywallet-api-x86_64-apple-darwin`
            - macOS Apple Silicon: `nozywallet-api-aarch64-apple-darwin`
            
            ### üìù Installation Instructions
            
            **Windows:**
            1. Download `nozy-windows.exe`
            2. Run the executable directly
            
            **Linux:**
            1. Download `nozy-linux`
            2. Make it executable: `chmod +x nozy-linux`
            3. Run: `./nozy-linux`
            
            **macOS:**
            1. Download the appropriate version for your Mac:
               - Intel Macs: `nozy-macos-intel`
               - Apple Silicon (M1/M2/M3): `nozy-macos-arm`
            2. Make it executable: `chmod +x nozy-macos-*`
            3. Run: `./nozy-macos-*`
            
            **Note:** Desktop client builds are not included in this release. The desktop client is in a separate repository and will be released independently when ready.
            
            ### üîí Security
            
            All binaries are signed with SHA256 hashes. Verify downloads using `HASHES.txt` or the individual `.sha256` files.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

